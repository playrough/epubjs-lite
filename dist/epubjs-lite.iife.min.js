var EpubJSLite=(()=>{var v=Object.defineProperty;var S=Object.getOwnPropertyDescriptor;var B=Object.getOwnPropertyNames;var N=Object.prototype.hasOwnProperty;var F=(f,t)=>{for(var e in t)v(f,e,{get:t[e],enumerable:!0})},C=(f,t,e,r)=>{if(t&&typeof t=="object"||typeof t=="function")for(let i of B(t))!N.call(f,i)&&i!==e&&v(f,i,{get:()=>t[i],enumerable:!(r=S(t,i))||r.enumerable});return f};var L=f=>C(v({},"__esModule",{value:!0}),f);var k={};F(k,{Book:()=>E,ContainerParser:()=>y,NavParser:()=>b,OPFParser:()=>_,Rendition:()=>x,Spine:()=>w,ZipStore:()=>g});var g=class f{constructor(t){this._zip=t}static async fromArrayBuffer(t,e={}){let r=e.JSZip||(typeof window<"u"?window.JSZip:void 0);if(!r)throw new Error("JSZip is not available. Provide options.JSZip or include it via CDN.");let i=await r.loadAsync(t);return new f(i)}async read(t,e="text"){let r=this._zip.file(t);if(!r)throw new Error(`File not found in zip: ${t}`);return e==="text"||e==="string"?await r.async("text"):e==="uint8array"?await r.async("uint8array"):e==="arraybuffer"?await r.async("arraybuffer"):e==="blob"?await r.async("blob"):await r.async("text")}};var y=class{static async fromZip(t){let e=await t.read("META-INF/container.xml","text"),i=new DOMParser().parseFromString(e,"application/xml");if(i.getElementsByTagName("parsererror")[0])throw new Error("Failed to parse container.xml");let o=Array.from(i.getElementsByTagName("rootfile"));if(o.length===0&&i.getElementsByTagNameNS&&(o=Array.from(i.getElementsByTagNameNS("*","rootfile"))),o.length===0)throw new Error("No <rootfile> found in container.xml");let n=(o.find(a=>a.getAttribute("media-type")==="application/oebps-package+xml")||o[0]).getAttribute("full-path");if(!n)throw new Error("Missing full-path attribute in container.xml rootfile");return n}};var _=class{static parse(t){let r=new DOMParser().parseFromString(t,"application/xml");if(r.getElementsByTagName("parsererror")[0])throw new Error("Failed to parse OPF");let s=this._parseMetadata(r),o=this._parseManifest(r),l=this._parseSpine(r);return{metadata:s,manifest:o,spine:l}}static _getFirst(t,e){let r=t.getElementsByTagName(e)[0];if(r)return r;if(t.getElementsByTagNameNS){let i=t.getElementsByTagNameNS("*",e)[0];if(i)return i}return null}static _getAll(t,e){let r=Array.from(t.getElementsByTagName(e));return r.length===0&&t.getElementsByTagNameNS&&(r=Array.from(t.getElementsByTagNameNS("*",e))),r}static _text(t){return t&&t.textContent?t.textContent.trim():""}static _parseMetadata(t){let e=this._getFirst(t,"package"),r=e?this._getFirst(e,"metadata"):this._getFirst(t,"metadata"),i={title:null,language:null,creators:[],publisher:null,identifiers:[]};if(!r)return i;let s=this._getFirst(r,"title");s&&(i.title=this._text(s));let o=this._getFirst(r,"language");o&&(i.language=this._text(o));let l=this._getAll(r,"creator");i.creators=l.map(a=>this._text(a)).filter(Boolean);let c=this._getFirst(r,"publisher");c&&(i.publisher=this._text(c));let n=this._getAll(r,"identifier");return i.identifiers=n.map(a=>this._text(a)).filter(Boolean),i}static _parseManifest(t){let e=this._getFirst(t,"manifest"),r={};if(!e)return r;let i=this._getAll(e,"item");for(let s of i){let o=s.getAttribute("id");o&&(r[o]={href:s.getAttribute("href")||"",mediaType:s.getAttribute("media-type")||"",properties:s.getAttribute("properties")||""})}return r}static _parseSpine(t){let e=this._getFirst(t,"spine"),r=[];if(!e)return r;let i=this._getAll(e,"itemref");for(let s of i){let o=s.getAttribute("idref");if(!o)continue;let l=(s.getAttribute("linear")||"yes").toLowerCase();r.push({idref:o,linear:l!=="no"})}return r}};function d(f){let t=f.lastIndexOf("/");return t===-1?"":f.slice(0,t+1)}function m(f,t,{keepHash:e=!1}={}){if(!t)return"";if(t.startsWith("/"))return decodeURIComponent(t.slice(1));let r=new URL(t,"http://x/"+(f||"")),i=decodeURIComponent(r.pathname.slice(1));return e?i+(r.hash||""):i}var w=class f{constructor(t,e){this.opfPath=t,this.baseDir=d(t),this._items=[];let{manifest:r={},spine:i=[]}=e||{};i.forEach((s,o)=>{let l=r[s.idref];if(!l){console.warn("[Spine] Missing manifest item for idref:",s.idref),this._items.push({index:o,idref:s.idref,href:null,linear:!!s.linear,mediaType:"",properties:""});return}let c=m(this.baseDir,l.href);this._items.push({index:o,idref:s.idref,href:c,linear:!!s.linear,mediaType:l.mediaType||"",properties:l.properties||""})})}static from(t,e){return new f(t,e)}get items(){return this._items}get length(){return this._items.length}get(t){return this._items[t]||null}firstLinearIndex(){for(let t=0;t<this._items.length;t++)if(this._items[t]?.linear&&this._items[t]?.href)return t;return this._items.length>0?0:-1}nextLinearIndex(t){for(let e=t+1;e<this._items.length;e++)if(this._items[e]?.linear&&this._items[e]?.href)return e;return t}prevLinearIndex(t){for(let e=t-1;e>=0;e--)if(this._items[e]?.linear&&this._items[e]?.href)return e;return t}};var b=class{static parse(t,e=""){let i=new DOMParser().parseFromString(t,"application/xhtml+xml");if(i.getElementsByTagName("parsererror")[0])throw new Error("Failed to parse nav.xhtml");let o=this._getTocNavElement(i);if(!o)throw new Error("No <nav> with toc found in nav.xhtml");let l=o.querySelector("ol");return l?this._extractList(l,e):[]}static _getTocNavElement(t){let e=Array.from(t.getElementsByTagName("nav"));for(let r of e){let i=r.getAttribute("epub:type");if(i&&i.toLowerCase().includes("toc"))return r}for(let r of e){let i=r.getAttribute("role");if(i&&i.toLowerCase()==="doc-toc")return r}for(let r of e)if((r.getAttribute("id")||"").toLowerCase()==="toc")return r;return null}static _extractList(t,e){let r=[],i=Array.from(t.children).filter(s=>s.tagName.toLowerCase()==="li");for(let s of i){let o=s.querySelector(":scope > a, :scope > span > a")||s.querySelector("a");if(!o)continue;let l=(o.textContent||"").trim(),c=o.getAttribute("href")||"",n=m(e,c,{keepHash:!0}),a=s.querySelector(":scope > ol"),h=a?this._extractList(a,e):[];r.push({label:l,href:n,children:h})}return r}};var x=class{constructor(t,e,r={}){if(this.book=t,this.options=r,this.container=this._resolveElement(e),!this.container)throw new Error("[Rendition] container element not found");this.index=0,this._blobUrls=[],this._iframe=null,this._doc=null}_resolveElement(t){return typeof t=="string"?document.querySelector(t):t}_ensureIframe(){if(!this._iframe||!this._iframe.contentDocument){this.container.innerHTML="";let t=document.createElement("iframe");t.style.width="100%",t.style.height="100%",t.style.border="0",t.style.display="block",this.container.appendChild(t),this._iframe=t}this._doc=this._iframe.contentDocument||this._iframe.contentWindow?.document,this._doc.open(),this._doc.write('<!doctype html><html><head><meta charset="utf-8"><style>body { margin: 16px; font-family: system-ui, Arial, sans-serif; } img { max-width: 100%; height: auto; } figure { margin: 0; }</style></head><body></body></html>'),this._doc.close()}_writeSkeleton(t){this._doc||this._ensureIframe();let e=(t||"").replace(/\ssrc=(["'])/gi," data-epub-src=$1");this._doc.body.innerHTML=e}scrollToTop(t={}){return this._scrollToTop(t)}_scrollToTop({behavior:t="auto"}={}){try{let e=this._iframe?.contentWindow;e&&typeof e.scrollTo=="function"&&e.scrollTo({top:0,left:0,behavior:t});let r=this._doc;if(r){let i=r.documentElement||r.getElementsByTagName("html")?.[0];i&&(i.scrollTop=0),r.body&&(r.body.scrollTop=0)}}catch{}try{this.container&&(this.container.scrollTop=0)}catch{}}async display(t){try{let{spine:e,zip:r}=this.book,i=null,s=-1,o=null;if(typeof t=="number"){let n=e.get(t);if(!n||!n.href)throw new Error(`[Rendition] Invalid spine index: ${t}`);i=n.href,s=t}else if(typeof t=="string"){let n=t,a=n.indexOf("#"),h=a>=0?n.slice(0,a):n;if(o=a>=0?n.slice(a+1):null,!h||h.trim()==="")return;i=h,s=this._findSpineIndexByHref(h)}else{let n=e.firstLinearIndex();i=e.get(n)?.href||null,s=n}if(!i)throw new Error("[Rendition] No target href to display");this._revokeBlobUrls();let l=await r.read(i,"text"),c=this._extractBodyHtml(l);if(this._ensureIframe(),this._writeSkeleton(c),await this._inlineStylesFromXhtml(l,i),await this._rewriteImages(i),!o&&this.options?.scrollToTopOnChapterChange!==!1&&this._scrollToTop({behavior:"auto"}),s>=0&&(this.index=s),o&&this._doc)try{let n=this._doc.getElementById(o),a=n?null:this._doc.querySelector(`[name="${o}"]`),h=n||a;h&&typeof h.scrollIntoView=="function"&&h.scrollIntoView({block:"start"})}catch{}}catch(e){console.warn("[Rendition] Failed to display content:",e),this.container.innerHTML=`<div style="padding:12px;color:#b00;">Failed to display content: ${e.message||e}</div>`}}next(){let{spine:t}=this.book,e=t.nextLinearIndex(this.index);if(e!==this.index)return this.display(e)}prev(){let{spine:t}=this.book,e=t.prevLinearIndex(this.index);if(e!==this.index)return this.display(e)}_extractBodyHtml(t){let e=new DOMParser,r=e.parseFromString(t,"application/xhtml+xml");r.getElementsByTagName("parsererror").length>0&&(r=e.parseFromString(t,"text/html"));let i=r.body||r.getElementsByTagName("body")[0]||r.documentElement;return i?i.innerHTML:t}_findSpineIndexByHref(t){let e=this.book.spine.items,r=t;for(let i=0;i<e.length;i++)if(e[i].href===r)return i;return-1}_revokeBlobUrls(){this._blobUrls&&this._blobUrls.length&&this._blobUrls.forEach(t=>{try{URL.revokeObjectURL(t)}catch{}}),this._blobUrls=[]}async _rewriteImages(t){try{let e=d(t),r=this._doc||this.container,i=Array.from(r.querySelectorAll("img[data-epub-src], img[src]"));if(!i.length)return;for(let s of i){let o=(s.getAttribute("data-epub-src")||s.getAttribute("src")||"").trim();if(!o)continue;let l=o.toLowerCase();if(l.startsWith("http://")||l.startsWith("https://")||l.startsWith("data:")||l.startsWith("blob:"))continue;let c=m(e,o);try{let n=await this.book.zip.read(c,"blob"),a=URL.createObjectURL(n);s.removeAttribute("data-epub-src"),s.src=a,this._blobUrls.push(a)}catch(n){console.warn("[Rendition] Failed to load image from zip:",c,n)}}}catch(e){console.warn("[Rendition] _rewriteImages failed:",e)}}async _inlineStylesFromXhtml(t,e){try{let r=new DOMParser,i=r.parseFromString(t,"application/xhtml+xml");i.getElementsByTagName("parsererror").length>0&&(i=r.parseFromString(t,"text/html"));let s=d(e),o=Array.from(i.querySelectorAll('link[rel~="stylesheet"][href]'));for(let c of o){let n=(c.getAttribute("href")||"").trim();if(!n)continue;let a=n.toLowerCase();if(a.startsWith("http://")||a.startsWith("https://")||a.startsWith("data:")||a.startsWith("blob:"))continue;let h=m(s,n);try{let p=await this.book.zip.read(h,"text"),u=d(h),A=await this._rewriteCssUrls(p,u),T=this._doc.createElement("style");T.textContent=A,this._doc.head.appendChild(T)}catch(p){console.warn("[Rendition] Failed to inline CSS:",h,p)}}let l=Array.from(i.getElementsByTagName("style"));for(let c of l){let n=(c.getAttribute("type")||"").trim().toLowerCase();if(n&&n!=="text/css")continue;let a=c.textContent||"";if(!a.trim())continue;let h=await this._rewriteCssUrls(a,s),p=this._doc.createElement("style");p.textContent=h,this._doc.head.appendChild(p)}}catch(r){console.warn("[Rendition] _inlineStylesFromXhtml failed:",r)}}async _rewriteCssUrls(t,e){let r=/url\(\s*(['"]?)([^'"\)]+)\1\s*\)/g,i=[],s=[],o;for(;(o=r.exec(t))!==null;){let c=o[0],n=o[2].trim(),a=n.toLowerCase();if(!n||a.startsWith("data:")||a.startsWith("http://")||a.startsWith("https://")||a.startsWith("blob:"))continue;let h=m(e,n);s.push(this.book.zip.read(h,"blob").then(p=>{let u=URL.createObjectURL(p);this._blobUrls.push(u),i.push({orig:c,repl:`url('${u}')`})}).catch(p=>{console.warn("[Rendition] Failed to load CSS asset:",h,p)}))}await Promise.all(s);let l=t;for(let{orig:c,repl:n}of i)l=l.split(c).join(n);return l}};var E=class f{constructor(t={}){this.options=t,this._navigation=[]}static async open(t,e={}){t instanceof ArrayBuffer||console.warn("[M4] Book.open: only ArrayBuffer is supported at this stage");let r=await g.fromArrayBuffer(t,e),i=await y.fromZip(r),s=await r.read(i,"text"),o=_.parse(s),l=w.from(i,o),c=new f(e);c.zip=r,c.opfPath=i,c.opf=o,c.spine=l;try{let n=d(i),a=Object.values(o.manifest||{}).find(h=>(h.properties||"").toLowerCase().split(/\s+/).includes("nav"));if(a?.href){let h=m(n,a.href),p=await r.read(h,"text"),u=d(h);c._navigation=b.parse(p,u)}else c._navigation=[]}catch(n){console.warn("[M5] Failed to load/parse navigation (toc):",n),c._navigation=[]}return c}renderTo(t,e={}){return new x(this,t,e)}get navigation(){return this._navigation||[]}};return L(k);})();
